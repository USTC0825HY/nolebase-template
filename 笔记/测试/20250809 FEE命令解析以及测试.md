# NFEB 命令接收逻辑梳理
## 1 先来说时钟链路
时钟有两个来源 
- fpga_local_clk (40 M)
- DAQ 传来的 16 MHz 差分时钟
大概的功能分类如下：
- **clk 40 M**: 系统主时钟，所有控制逻辑
	- fec_elink_top（E-link接口）
	- command（命令解析）
	- datacheck（命令校验）
	- s_curve_manager（S曲线计数）
	- auto_mod（自动采集状态机）
	- spiroc_reset（SPIROC复位控制）
	- SlowControl（慢控制/移位寄存器）
	- shifter_send（读功能移位
	- autotrigger_gen（自动触发生成）
	- strech（LED指示灯）
	- data_socket（数据包读/写时钟2）
	- dac_comm（高压DAC控制）
	- clk1M_gen（1MHz分频源）
- 其他调试/辅助模块
- **clk16M**: E-link协议处理、与40MHz同步
- **clk80M**: E-link高速处理、clk40M生成源
- **clk160M**: E-link串行数据刷新
- **clk200M**: IDELAY校准参考时钟
- **clk_sc10M**: 慢控时钟10MHz
- **slow_clock**: SPIROC慢时钟(5MHz/1MHz/250kHz可选)
- **clk1M**: HV/温度等外设时钟
时钟树如下：
``` mermaid
graph LR
    %% 输入时钟源
    FPGA_CLK[FPGA_GLOBAL_CLK] -->|IBUFG| localCLK40M[localCLK40M]
    GBT_CLKP & GBT_CLKN -->|差分输入| PLL[clk_wiz_1 PLL]
    
    %% PLL输出的多个时钟域
    PLL -->|clk_16m| clk16M[clk16M - 16MHz]
    PLL -->|clk_80m| clk80M[clk80M - 80MHz] 
    PLL -->|clk_160m| clk160M[clk160M - 160MHz]
    PLL -->|clk_sc10m| clk_sc10M[clk_sc10M - 10MHz]
    PLL -->|clk_200m| clk200M[clk200M - 200MHz]
    
    %% 特殊的40M时钟生成链路
    clk80M -->|分频器clk40M_r| BUFG_40M[BUFG clk40M_bufg]
    BUFG_40M -->|clk40M| clk40M[clk40M - 40MHz主时钟]
    
    %% 慢时钟生成链路
    clk40M -->|rt_trig_manager| slow_clock_pre[slow_clock_pre]
    slow_clock_pre -->|250ns延迟| slow_clock[slow_clock]
    slow_clock_pre -->|cook_timing分频器| sync_trig[sync_trig]
    
    %% 1MHz时钟生成
    clk40M -->|clk1M_gen分频器| clk1M[clk1M - 1MHz]
    
    %% 本地时钟应用
    localCLK40M -->|FIFO复位控制逻辑| FIFO_RST[fifoRst计数器]
    
    %% 主要模块的时钟连接
    clk40M -->|主时钟| COMMAND[command模块]
    clk40M -->|主时钟| DATACHECK[datacheck模块]
    clk40M -->|主时钟| S_CURVE[s_curve_manager模块]
    clk40M -->|主时钟| AUTO_MOD[auto_mod模块]
    clk40M -->|主时钟| SPIROC_RST[spiroc_reset模块]
    clk40M -->|主时钟| SLOW_CTRL[SlowControl模块]
    clk40M -->|主时钟| SHIFTER[shifter_send模块]
    clk40M -->|主时钟| AUTO_TRIG[autotrigger_gen模块]
    clk40M -->|主时钟| STRECH1[strech指示器模块]
    clk40M -->|主时钟| DATA_SOCK_RD[data_socket读时钟]
    clk40M -->|主时钟| HV_DAC[dac_comm模块]
    
    %% 慢时钟应用
    slow_clock -->|慢时钟| AUTO_MOD
    slow_clock -->|慢时钟| SPIROC_RST
    slow_clock -->|写时钟| DATA_SOCK_WR[data_socket写时钟1]
    
    %% E-link接口多时钟域
    clk16M -->|16M同步时钟| ELINK[fec_elink_top模块]
    clk40M -->|主时钟| ELINK
    clk80M -->|80M高速时钟| ELINK
    clk160M -->|160M数据刷新时钟| ELINK
    clk200M -->|200M参考时钟| ELINK
    
    %% 10MHz慢控制时钟
    clk_sc10M -->|慢控制时钟| SLOW_CTRL
    
    %% 80MHz应用
    clk80M -->|命令寄存器时钟| CMD_REG[命令寄存器逻辑]
    clk80M -->|E-link复位控制| ELINK_RST[elink复位逻辑]
    
    %% 1MHz应用
    clk1M -->|ADC控制时钟| ADC_CTRL[adc_control模块]
    clk1M -->|温度传感器时钟| TEMP_SENSOR[DS18B20_sensor模块]
    
    %% 200MHz应用（调试用）
    clk200M -->|ILA调试时钟| ILA_ADC[ila_adc模块]
    clk200M -->|ILA调试时钟| ILA_TRIG[ila_trigger模块]
    clk200M -->|ADC ILA输入| ADC_CTRL
    
    %% 输出到外部芯片的时钟
    clk40M -->|OBUFDS差分输出| CLK_40M_OUT[CLK_40M_P/N → SPIROC]
    slow_clock -->|OBUFDS差分输出| CLK_5M_OUT[CLK_5M_P/N → SPIROC]
    
    %% 生成的控制时钟输出
    SLOW_CTRL -->|慢控制时钟输出| SR_CK_OUT[SR_CK → SPIROC]
    SHIFTER -->|读功能时钟输出| CLK_READ_OUT[CLK_READ → SPIROC]
    HV_DAC -->|HV DAC时钟输出| HV_CLK_OUT[HV_DAC_CLK_0]
    ADC_CTRL -->|HV ADC时钟输出| HV_ADC_CLK_OUT[HV_ADC_SCLK]
    
    %% 时钟域说明
    classDef inputClk fill:#e1f5fe
    classDef pllClk fill:#f3e5f5
    classDef mainClk fill:#e8f5e8
    classDef slowClk fill:#fff3e0
    classDef moduleClk fill:#fce4ec
    classDef outputClk fill:#f1f8e9
    
    class FPGA_CLK,GBT_CLKP,GBT_CLKN inputClk
    class PLL,clk16M,clk80M,clk160M,clk_sc10M,clk200M pllClk
    class clk40M,localCLK40M mainClk
    class slow_clock,slow_clock_pre,clk1M slowClk
    class COMMAND,DATACHECK,S_CURVE,AUTO_MOD,SPIROC_RST,SLOW_CTRL,SHIFTER,AUTO_TRIG,STRECH1,ELINK,HV_DAC,ADC_CTRL moduleClk
    class CLK_40M_OUT,CLK_5M_OUT,SR_CK_OUT,CLK_READ_OUT,HV_CLK_OUT,HV_ADC_CLK_OUT outputClk
```

## 2 再来说命令接收&处理链路
``` plaintxt
GBT差分输入 → E-link解码 	→ 命令解析 		→ 功能配置
   ↓              					↓          			 ↓          				↓
GBT_DINP/N → fec_elink_top → command 		→ 各子模块
   ↓              					↓           				↓          			↓
差分转单端    → 16位命令字  	→ 操作码解析 	→ 控制信号
```
### 2.1 命令接收链路
- 物理层数据通过 `fec_elink_top` 模块的 `data_in_from_pin_i (gbtDin)` 输入。
- `fec_elink_top` 负责解码，输出：
    - `rx_cmd_raw[15:0]`：解码后的16位命令数据
    - `rxf_sync_out_raw`：命令数据有效标志（高电平时数据有效）

### 2.2 命令处理链路

### 2.3 时钟域问题
``` verilog
always @ (negedge clk80M) begin
  rx_cmd_reg <= rx_cmd_raw; 
  rxf_sync_out_reg <= rxf_sync_out_raw;
end
assign rx_cmd = rx_cmd_reg;
assign rxf_sync_out = rxf_sync_out_reg;
```
rx_cmd rxf_sync_out 都是 80 M 时钟采样的数据，但是最后输送给 command ，其读写时钟分别是
``` verilog
command #(.SYNC(SYNC)) command_0 (
  .cmd_data_in    (rx_cmd[15:0]),
  .cmd_en         (rxf_sync_out & idelayReady),
  .rd_clk         (clk40M),
  .wr_clk         (clk40M),
  .rst_n          (rst_n),
  .soft_rst       (~fifoRst),
  // ...output ports...
);
```

### 2.4 命令码功能描述表

解释信号
输入的命令信号为cmd_data_in[15:0] 
- 高八位 cmd_data_in[15:8] 为命令类型（类似要写的寄存器的地址），这里称之为 cmd_code ；
- 低八位 cmd_data_in[7:0] 为写的具体内容（给对应寄存器配置的实际信），这称之为 cmd_data ;
下面是配置 FEE 的所有 cmd 的具体功能描述

| cmd_code     | 命令码  | 参数    | 功能描述        | 输出信号                                | cmd_data | 备注                           |
| ------------ | ---- | ----- | ----------- | ----------------------------------- | -------- | ---------------------------- |
| START_ACQ    | 0x01 | 无     | 启动自动数据采集    | `start_en=1`                        |          | pulse_list[0]                |
| END_ACQ      | 0x02 | 无     | 结束自动数据采集    | `end_en=1`                          |          | pulse_list[1]                |
| ==CFG_DATA== | 0x03 | [7:0] | 传输配置数据到选定模块 | `cfig_data_reg`, `cfg_data_valid=1` |          | 下发config，如慢控制                |
| RST_SPIROC   | 0x04 | 无     | 复位SPIROC芯片  | `rst_spiroc=1`                      |          | pulse_list[3]                |
| SEL_MODULE   | 0x05 | [7:0] | 选择传输模块      | `xfer_mod_sel_reg`                  |          | SC/HV/DataSocket选择           |
| SEL_REG      | 0x06 | [0]   | 选择探针/慢控寄存器  | `select_reg`                        |          | 0=慢控, 1=探针                   |
| LED_DAC_CFG  | 0x07 | [7:0] | LED DAC配置   | `led_dac_en=1`, `cfig_data_reg`     |          | LED校准DAC设置                   |
| SC_START     | 0x08 | 无     | 慢控或探针配置启动   | `sc_start=1`                        |          | pulse_list[2]                |
| TDC_EXT_FLAG | 0x09 | [0]   | TDC外部标志选择   | `flag_tdc_ext_reg`                  |          | AVDD选择                       |
| READ_CFG     | 0x0A | [7:0] | 读功能配置       | `read_en=1`, `cfig_data_reg`        |          | pulse_list[4]                |
| LED_CFG      | 0x0B | [7:0] | LED配置       | `led_cfg_en=1`, `cfig_data_reg`     |          | LED校准配置                      |
| TRIG_CTRL    | 0x0C | [2:0] | 触发控制        | `r_time_reg`                        |          | t_e, v_e, r_c使能              |
| POWER_PULSE  | 0x0D | [3:0] | 功耗脉冲向量      | `powerpulsing_vector_reg`           |          | 4路功耗控制                       |
| TRIG_NUM     | 0x0E | [4:0] | 触发数量        | `trigger_num_reg`                   |          | 触发次数设置                       |
| E_DAC_CFG    | 0x0F | [7:0] | 电子校准DAC配置   | `e_dac_en=1`, `cfig_data_reg`       |          | 电子校准DAC                      |
| LED_PULSE    | 0x10 | 无     | LED脉冲触发     | `led_pulse=1`                       |          | LED校准脉冲                      |
| S_CURVE_EN   | 0x11 | [0]   | S曲线计数使能     | `s_curve_count_en`                  |          | S曲线测量                        |
| E_CALIB_CFG  | 0x12 | [7:0] | 电子校准配置      | `e_calib_cfg_en=1`, `cfig_data_reg` |          | 电子校准设置                       |
| CHIP_NUM     | 0x13 | [3:0] | 芯片数量        | `chip_num`                          |          | 目标芯片选择                       |
| E_PULSE      | 0x14 | 无     | 电子校准脉冲      | `e_pulse=1`                         |          | 电子校准触发                       |
| SLOW_RATE    | 0x15 | [1:0] | 慢时钟分频率      | `slow_rate`                         |          | 时钟分频设置<br>0-1M 1-500K 2-250K |
| SYNC_SPEED   | 0x16 | [1:0] | 同步速度        | `sync_speed`                        |          | 同步时钟速度<br>0-1000             |
| TEMP_START   | 0x17 | 无     | 温度测量启动      | `temp_start=1`                      |          | 温度传感器启动                      |
| TEMP_CFG     | 0x18 | [7:0] | 温度配置        | `temp_cfg_en=1`, `cfig_data_reg`    |          | 温度传感器配置                      |
| TRIG_CFG     | 0x19 | [7:0] | 触发配置        | `trigger_cfg_en=1`, `cfig_data_reg` |          | 触发参数配置                       |
| LIMIT_ACQ_EN | 0x1A | [0]   | 限制采集使能      | `limitAcqEn`                        |          | 采集限制控制                       |
| MASK_LENGTH  | 0x1B | [7:0] | 掩码长度        | `maskLength`                        |          | 掩码持续时间                       |
| SCLK_SYNC    | 0x1C | 无     | 慢时钟同步       | `sclk_sync=1`                       |          | 慢时钟同步脉冲                      |
| RST_FPGA     | 0x1D | 无     | FPGA复位      | `rst_fpga_o=1`                      |          | FPGA软复位                      |
| RESET_PULSE  | 0x1E | 无     | 复位脉冲        | `reset_pulse=1`                     |          | 通用复位脉冲                       |
| HV0_DAC_CFG  | 0x30 | [7:0] | HV0 DAC配置   | `HV0_dac_en=1`, `cfig_data_reg`     |          | 高压DAC配置                      |
| HV0_EN       | 0x31 | [0]   | HV0使能       | `HV0_en`                            |          | 高压0通道使能                      |
| HV_ADC_EN    | 0x32 | [0]   | HV ADC使能    | `HV_ADC_en`                         |          | 高压ADC使能                      |

现在举个例子，现在给出 dac 280. Dat 关于 fee 的配置信息
``` plaintxt
1301 0000 0000 0000 0000 0C01 0000 0000 0000 0000 0E01 0000 0000 0000 0000 0000 1502 0000 0000 0000 0000 0000 1600 0000 0000 0000 0000 0000 1964 0000 0000 0000 0000 0000 0601 0000 0000 0000 0000 0000 0501 0000 0000 0000 0000 0000 03AE 03AB 03AB 0350 0300 0300 0300 0300 0300 0300 0300 0300 0300 0300 0300 0300 0300 0300 0300 0300 0300 0300 0303 0354 0300 0300 0300 0300 0320 035F 03F8 03C4 03B4 0311 038C 033A 03A0 0375 0340 03EA 0381 03D5 0303 03AA 0307 0354 030E 03A8 031D 0350 033A 03A0 0375 0340 03EA 0381 03D5 0303 03AA 0307 0354 030E 03A8 031D 0350 033A 03A0 0375 0340 03EA 0381 03D5 0303 03AA 0307 0354 030E 03A8 031D 0350 033A 03A0 0375 0340 03EA 0381 03D5 0303 03AA 0307 0354 030E 03A8 031D 0350 033A 03A0 0375 0340 03EA 0381 03D5 030A 036C 0376 033B 031D 038E 03C7 0363 03B1 03D8 03EC 0376 033B 031D 038E 03C7 0363 03B1 03D8 03EC 0376 033B 031D 038E 03C7 0363 03B1 03D8 03EC 0376 033B 031D 038E 03C7 0363 03B1 03D8 03EC 0376 033B 031D 038E 0304 0301 0380 0300 0300 0500 0800 3101 3082 309A
```

接下来进行解释:
#### 2.4.1 第一部分：系统初始化配置 (8个命令)
``` plaintxt
1301 - CMD_CHIP_NUM (0x13) + 数据0x01
      → 设置芯片数量为1片
      → trig_ctrl_reg ← 0x01，输出chip_num = 4'b0001

0C01 - CMD_TRIG_CTRL (0x0C) + 数据0x01  
      → 触发控制设置：r_c=1, v_e=0, t_e=0
      → trig_ctrl_reg ← 3'b001，输出r_c=1, v_e=0, t_e=0

0E01 - CMD_TRIGGER_NUM (0x0E) + 数据0x01
      → 设置触发数量为1
      → trigger_num_reg ← 5'b00001，输出trigger_num = 5'b00001

1502 - CMD_SLOW_RATE (0x15) + 数据0x02
      → 慢时钟分频设置为2
      → slow_rate_reg ← 2'b10，输出slow_rate = 2'b10

1600 - CMD_SYNC_SPEED (0x16) + 数据0x00
      → 同步速度设置为0  
      → sync_speed_reg ← 2'b00，输出sync_speed = 2'b00

1964 - CMD_TRIGGER_CFG (0x19) + 数据0x64
      → 触发配置，传输数据0x64
      → trigger_cfg_en_reg ← 1，cfig_data_reg ← 0x64，cfg_data_valid_reg ← 1

0601 - CMD_SELECT (0x06) + 数据0x01
      → 选择探测器寄存器模式
      → select_reg ← 1，输出select = 1

0501 - CMD_MODULE_SEL (0x05) + 数据0x01  
      → 选择HV模块进行数据传输
      → module_select_reg ← 3'b010，输出hv_xfering = 1
```
#### 2.4.2 第二部分：大量配置数据传输 (184个0x03命令-输送给 spiroc 的命令)

``` plaintxt
03AE - CMD_CFIG_DATA (0x03) + 数据0xAE
      → cfig_data_reg ← 0xAE，cfg_data_valid_reg ← 1

03AB - CMD_CFIG_DATA (0x03) + 数据0xAB  
      → cfig_data_reg ← 0xAB，cfg_data_valid_reg ← 1

03AB - CMD_CFIG_DATA (0x03) + 数据0xAB
      → cfig_data_reg ← 0xAB，cfg_data_valid_reg ← 1

0350 - CMD_CFIG_DATA (0x03) + 数据0x50
      → cfig_data_reg ← 0x50，cfg_data_valid_reg ← 1

... (继续传输180个配置数据) ...

0300 - CMD_CFIG_DATA (0x03) + 数据0x00 (多次重复)
0303 - CMD_CFIG_DATA (0x03) + 数据0x03  
0354 - CMD_CFIG_DATA (0x03) + 数据0x54
0320 - CMD_CFIG_DATA (0x03) + 数据0x20
035F - CMD_CFIG_DATA (0x03) + 数据0x5F
03F8 - CMD_CFIG_DATA (0x03) + 数据0xF8
03C4 - CMD_CFIG_DATA (0x03) + 数据0xC4
03B4 - CMD_CFIG_DATA (0x03) + 数据0xB4
0311 - CMD_CFIG_DATA (0x03) + 数据0x11
038C - CMD_CFIG_DATA (0x03) + 数据0x8C
033A - CMD_CFIG_DATA (0x03) + 数据0x3A
... (配置数据持续传输) ...
```
#### 2.4.3 第三部分：系统控制和HV操作 
``` plaintxt
0500 - CMD_MODULE_SEL (0x05) + 数据0x00
      → 取消模块选择，停止数据传输
      → module_select_reg ← 3'b000，所有xfering信号归零

0800 - CMD_SC_START (0x08) + 数据0x00  
      → 启动慢控制配置过程
      → sc_start_reg ← 1，输出sc_start = 1 (脉冲信号)

3101 - CMD_HV0_EN (0x31) + 数据0x01
      → 启用HV0高压模块
      → HV0_en_reg ← 1，输出HV0_en = 1

3082 - CMD_HV_ADC_EN (0x32) + 数据0x82
      → 启用HV ADC，数据0x82 (二进制10000010)
      → HV_ADC_en_reg ← 1，输出HV_ADC_en = 1

309A - CMD_HV0_DAC (0x30) + 数据0x9A  
      → HV0 DAC配置，设置电压值0x9A (154)
      → HV0_dac_en_reg ← 1，cfig_data_reg ← 0x9A，cfg_data_valid_reg ← 1
```

1. 明天继续研究如何配置好多板的命令
2. 触发模式？
3. 多板符合？还没有研究该咋用？
## 3 命令码 cmd_code 附录
``` verilog
localparam CMD_START_EN         = 8'h01;
 localparam CMD_END_EN           = 8'h02;
 localparam CMD_CFIG_DATA        = 8'h03;
 localparam CMD_RST_SPIROC       = 8'h04;
 localparam CMD_MODULE_SEL       = 8'h05;
 localparam CMD_SELECT           = 8'h06;
 localparam CMD_LED_DAC          = 8'h07;
 localparam CMD_SC_START         = 8'h08;
 localparam CMD_FLAG_TDC_EXT     = 8'h09;
 localparam CMD_READ_CFG         = 8'h0A;
 localparam CMD_LED_CFG          = 8'h0B;
 localparam CMD_TRIG_CTRL        = 8'h0C;
 localparam CMD_POWERPULSING     = 8'h0D;
 localparam CMD_TRIGGER_NUM      = 8'h0E;
 localparam CMD_E_DAC            = 8'h0F;
 localparam CMD_LED_PULSE        = 8'h10;
 localparam CMD_S_CURVE_EN       = 8'h11;
 localparam CMD_E_CALIB_CFG      = 8'h12;
 localparam CMD_CHIP_NUM         = 8'h13;
 localparam CMD_E_PULSE          = 8'h14;
 localparam CMD_SLOW_RATE        = 8'h15;
 localparam CMD_SYNC_SPEED       = 8'h16;
 localparam CMD_TEMP_START       = 8'h17;
 localparam CMD_TEMP_CFG         = 8'h18;
 localparam CMD_TRIGGER_CFG      = 8'h19;
 localparam CMD_LIMIT_ACQ_EN     = 8'h1A;
 localparam CMD_MASK_LENGTH      = 8'h1B;
 localparam CMD_SCLK_SYNC        = 8'h1C;
 localparam CMD_RST_FPGA_O       = 8'h1D;
 localparam CMD_RESET_PULSE      = 8'h1E;
 localparam CMD_HV0_DAC          = 8'h30;
 localparam CMD_HV0_EN           = 8'h31;
 localparam CMD_HV_ADC_EN        = 8'h32;
```

# 参考
https://www.yuque.com/zhuangh/hlh2wb/gm9r85ogxgi380du 【手册】1m DAQ使用